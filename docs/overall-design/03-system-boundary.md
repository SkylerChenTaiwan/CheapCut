# 步驟 3：系統邊界劃分

**狀態**：🔄 討論中
**前置依賴**：01-product-core.md, 02-key-flows.md
**目標**：定義哪些我們做、哪些用外部服務

---

## 要回答的核心問題

### 1. 系統邊界總覽

**目的**：清楚劃分「自己開發」vs「使用外部服務」的界線

**核心原則**：
- ✅ **我們做**：與產品核心價值直接相關、需要客製化的部分
- ❌ **外包/購買**：通用能力、成熟的第三方服務可以做得更好更便宜

---

## 系統邊界圖

```
┌─────────────────────────────────────────────────────────────┐
│                        CheapCut 系統                          │
│                                                               │
│  ┌──────────────────────────────────────────────────────┐  │
│  │                   我們自己開發                        │  │
│  │                                                        │  │
│  │  • 前端 Web 應用（用戶介面）                           │  │
│  │  • 後端 API 服務                                       │  │
│  │  • 素材管理邏輯                                        │  │
│  │  • 影片生成流程控制                                    │  │
│  │  • 時間軌編輯器                                        │  │
│  │  • 用戶認證與權限管理                                  │  │
│  │  • 資料庫設計與管理                                    │  │
│  │  • AI Prompt 設計與優化                                │  │
│  │  • 智能選片邏輯（導演決策引擎）                        │  │
│  │                                                        │  │
│  └────────────────┬───────────────────────────────────────┘  │
│                   │                                           │
│                   │ API 呼叫                                  │
│                   │                                           │
│  ┌────────────────▼───────────────────────────────────────┐  │
│  │                  外部服務整合                          │  │
│  │                                                        │  │
│  │  • 影片儲存（雲端儲存服務）                            │  │
│  │  • 影片處理（影片分析、轉碼、合成）                    │  │
│  │  • AI 服務（STT、語意分析、視覺辨識）                  │  │
│  │  • 配樂庫（版權音樂 API）                              │  │
│  │  • 字幕樣式/特效（可能用現成方案）                     │  │
│  │                                                        │  │
│  └────────────────────────────────────────────────────────┘  │
│                                                               │
└─────────────────────────────────────────────────────────────┘

外部用戶 ──→ 瀏覽器/App ──→ CheapCut 系統 ──→ 第三方服務
```

---

## 功能邊界拆解

### 功能 1：影片儲存與管理

**需求**：
- 儲存用戶上傳的影片素材
- 儲存生成的成品影片
- 提供下載功能

**決策**：❌ 不自建 → ✅ 使用雲端儲存服務

**選擇外部服務的理由**：
- 儲存是通用需求，成熟服務更穩定
- 自建成本高（伺服器、頻寬、維護）
- 需要 CDN 加速下載，外部服務已整合

**候選服務**：
- AWS S3 + CloudFront
- Google Cloud Storage
- Cloudflare R2（可能更便宜）

**我們要做的部分**：
- 設計檔案命名規則
- 管理上傳權限（presigned URL）
- 追蹤檔案狀態（資料庫記錄）

---

### 功能 2：影片分析（場景辨識、片段切分）

**需求**：
- 分析影片內容（人物、場景、動作、情緒）
- 自動切分片段
- 生成縮圖

**決策**：❌ 不自己訓練模型 → ✅ 使用現成 AI 服務

**選擇外部服務的理由**：
- 視覺辨識模型訓練成本極高
- 現成服務（Google Video AI、AWS Rekognition）已經很成熟
- 我們的核心價值不在「辨識技術」而在「應用邏輯」

**候選服務**：
- Google Cloud Video Intelligence API
- AWS Rekognition Video
- Azure Video Indexer

**我們要做的部分**：
- 設計 API 整合邏輯
- 將 API 回傳結果轉換為我們的 tag 系統
- 決定哪些標籤有用、如何分類
- 片段切分邏輯優化（基於 API 結果進行二次處理）

---

### 功能 3：語音轉文字（STT）

**需求**：
- 將用戶錄音轉為文字
- 提供時間軸標記（每句話的起始時間）

**決策**：❌ 不自己做 → ✅ 使用現成 STT 服務

**選擇外部服務的理由**：
- STT 是成熟技術，外部服務準確率高
- 支援多語言、方言
- 成本已經很低（每分鐘幾分錢）

**候選服務**：
- OpenAI Whisper API
- Google Cloud Speech-to-Text
- AssemblyAI

**我們要做的部分**：
- 處理 STT 結果（分句、標點符號優化）
- 信心分數檢查與用戶提示
- Forced alignment（文字稿對齊音軌）

---

### 功能 4：語意分析與內容理解

**需求**：
- 理解配音在講什麼（語意分析）
- 提取關鍵字、分析段落主題
- 為每個片段生成搜尋 tags

**決策**：✅ 我們自己做（但使用 LLM API）

**我們要做的部分**：
- 設計 AI Prompt（這是核心競爭力！）
- 將配音文字拆解成片段
- 為每個片段提取關鍵字
- 生成搜尋 tags 供選片使用

**使用的外部服務**：
- OpenAI API（GPT-4）
- Claude API
- 其他開源 LLM（Llama、Mistral 等）

**為什麼這部分是「我們做」**：
- Prompt 設計是產品差異化的關鍵
- 如何理解配音並匹配素材，決定了影片品質
- 這是「導演決策引擎」的核心邏輯

---

### 功能 5：智能選片（導演決策引擎）

**需求**：
- 從素材庫挑選適合的片段
- 決定剪輯節奏、長度分配
- 避免重複使用同一素材
- 產出影片時間軸

**決策**：✅ 完全我們自己做（核心價值！）

**這是產品的核心競爭力**：
- 「智能選片」的好壞直接決定影片品質
- 這是 CheapCut 與其他工具的差異所在
- 需要大量調校、優化、用戶反饋迭代

**我們要做的部分**：
- 設計選片演算法
- 設計「導演 Prompt」
- 資料庫查詢優化（tag 搜尋）
- 選片結果的檢查機制
- 候選片段排序邏輯

**使用的外部服務**：
- LLM API（用於決策，但邏輯由我們設計）

---

### 功能 6：影片合成與渲染

**需求**：
- 將素材片段組合在一起
- 加上配音、字幕、配樂
- 加上轉場特效
- 輸出 MP4 檔案

**決策**：❌ 不自己寫渲染引擎 → ✅ 使用外部影片處理服務

**選擇外部服務的理由**：
- 影片編碼、渲染是複雜技術
- 需要硬體加速（GPU）
- 自建成本高、效能難優化

**候選服務**：
- **選項 A：雲端影片處理 API**
  - AWS Elastic Transcoder
  - Mux Video API
  - Cloudflare Stream

- **選項 B：使用開源工具 + 自己架伺服器**
  - FFmpeg（影片合成）
  - Remotion（React-based 影片生成）
  - 在自己的伺服器或 Lambda 上執行

**我們要做的部分**：
- 設計影片合成的時間軸 JSON
- 決定轉場、特效的套用邏輯
- 字幕樣式設計
- 配樂選擇邏輯
- 呼叫 API 或執行 FFmpeg 指令

---

### 功能 7：配樂庫

**需求**：
- 提供背景音樂選項
- 根據影片情緒選擇合適配樂
- 避免版權問題

**決策**：❌ 不自己做 → ✅ 使用版權音樂 API

**候選服務**：
- Epidemic Sound API
- AudioJungle
- Uppbeat
- YouTube Audio Library（免費但有限制）

**我們要做的部分**：
- 設計配樂選擇邏輯（根據影片情緒、節奏）
- 管理配樂庫的 metadata（tags、風格分類）
- 配樂音量控制、淡入淡出

---

### 功能 8：字幕樣式與特效

**需求**：
- 提供多種字幕樣式
- 字幕動畫效果（淡入、滑動等）
- 字幕位置、大小、顏色

**決策**：✅ 我們自己做樣式設計（可用現成特效庫輔助）

**我們要做的部分**：
- 設計 3-5 種預設字幕樣式
- 決定字幕顯示規則（何時顯示、多久切換）
- 字幕排版邏輯

**可用的輔助工具/庫**：
- FFmpeg 字幕濾鏡
- CSS 動畫（如果用 Remotion）
- 預設的字幕模板庫

---

### 功能 9：用戶認證與權限管理

**需求**：
- 用戶註冊、登入
- 影片素材的隔離（不同用戶看不到彼此的素材）
- 付費方案管理

**決策**：🤔 混合模式

**選項 A：使用 Auth 服務**
- Firebase Authentication
- Auth0
- Supabase Auth

**選項 B：自己做**
- JWT + 自建用戶表
- 完全控制權限邏輯

**建議**：
- MVP 階段：使用 Firebase/Supabase（快速上線）
- 長期：可能自建（降低成本、客製化）

---

### 功能 10：資料庫

**需求**：
- 儲存用戶資料
- 儲存影片 metadata
- 儲存 segments 和 tags
- 儲存生成的影片記錄

**決策**：✅ 我們自己設計 schema（但可用雲端資料庫服務）

**資料庫選擇**：
- **選項 A：關聯式資料庫（推薦）**
  - PostgreSQL（自架或用 Supabase / Railway / Neon）
  - MySQL

- **選項 B：NoSQL**
  - Firebase Firestore
  - MongoDB

**建議**：PostgreSQL
- segments 和 tags 的關聯查詢需要關聯式資料庫
- 成熟、穩定、查詢效能好

**我們要做的部分**：
- 設計資料表 schema
- 設計索引優化查詢
- 資料庫遷移管理

---

### 功能 11：前端介面

**需求**：
- 用戶上傳介面
- 素材瀏覽介面
- 錄音功能
- 時間軌編輯器
- 影片預覽播放

**決策**：✅ 完全我們自己做

**這是產品體驗的核心**：
- 介面易用性決定用戶是否願意用
- 時間軌編輯器是核心功能
- 需要高度客製化

**技術選擇**：
- React / Next.js
- Vue / Nuxt.js
- Svelte / SvelteKit

**我們要做的部分**：
- 所有 UI/UX 設計
- 錄音功能整合（Web Audio API）
- 影片上傳進度條
- 時間軌拖拉介面

---

## 系統依賴外部服務清單

### 必須整合的外部服務（核心功能）

| 功能 | 外部服務 | 用途 | 預估成本 |
|------|----------|------|----------|
| 影片儲存 | AWS S3 / Cloudflare R2 | 儲存素材與成品 | 低（$0.01-0.02/GB） |
| 影片分析 | Google Video AI / AWS Rekognition | 場景辨識、打 tag | 中（$0.1-0.15/分鐘） |
| STT | OpenAI Whisper / AssemblyAI | 語音轉文字 | 低（$0.006/分鐘） |
| LLM | OpenAI GPT-4 / Claude | 語意分析、選片決策 | 中（$0.01-0.03/次） |
| 影片渲染 | FFmpeg（自架）或 Mux API | 影片合成 | 低-中（看選項） |

### 可選的外部服務（增強功能）

| 功能 | 外部服務 | 用途 | 優先級 |
|------|----------|------|--------|
| 配樂庫 | Epidemic Sound | 版權音樂 | 🟡 中 |
| 用戶認證 | Firebase Auth | 登入管理 | 🟢 高（MVP 可用） |
| 資料庫 | Supabase / Neon | PostgreSQL 託管 | 🟢 高 |
| Email 通知 | SendGrid / Resend | 發送通知 | 🔵 低 |

---

## 成本控制原則

### 原則 1：優先使用「按用量計費」的服務
- 避免固定月費（初期用量低，划不來）
- 選擇有免費額度的服務（例如：OpenAI、AWS）

### 原則 2：避免「黑箱 API」
- 如果某個 API 未來可能漲價 10 倍，我們要有替換方案
- 例如：影片分析可以從 Google 換到 AWS

### 原則 3：核心邏輯不依賴單一服務
- 智能選片邏輯要能用不同 LLM
- 影片合成可以切換不同渲染服務

---

## 風險評估

### 風險 1：外部 API 成本暴漲
**應對方式**：
- 設計抽象層，方便切換服務
- 關鍵功能有備用方案（例如：STT 可用 Whisper 自架）

### 風險 2：外部服務穩定性問題
**應對方式**：
- 對關鍵 API 設置 timeout 和 retry 機制
- 監控 API 回應時間

### 風險 3：依賴過多外部服務導致整合複雜
**應對方式**：
- MVP 階段只整合最少必要服務
- 逐步增加新服務

---

## 決策總結表

| 功能模組 | 我們做 | 外部服務 | 決策理由 |
|---------|--------|---------|---------|
| 前端介面 | ✅ | ❌ | 核心體驗，需客製化 |
| 後端 API | ✅ | ❌ | 核心邏輯控制 |
| 素材管理 | ✅ 邏輯 | ✅ 儲存（S3） | 邏輯自己做，儲存用外部 |
| 影片分析 | ✅ 整合 | ✅ AI API | 用外部 AI，我們設計整合邏輯 |
| STT | ❌ | ✅ | 成熟服務更好 |
| 語意分析 | ✅ Prompt 設計 | ✅ LLM API | Prompt 是核心，LLM 用外部 |
| 智能選片 | ✅ | ❌ | 核心競爭力！ |
| 影片合成 | ✅ 指令設計 | ✅ FFmpeg/API | 渲染用外部，邏輯自己設計 |
| 配樂 | ✅ 選擇邏輯 | ✅ 音樂庫 | 版權問題需外部庫 |
| 字幕樣式 | ✅ | 可用庫輔助 | 自己設計樣式 |
| 用戶認證 | 🤔 | 🤔 | MVP 可用外部，長期自建 |
| 資料庫 | ✅ Schema 設計 | ✅ 雲端託管 | Schema 自己設計，託管用外部 |

---

## 關鍵決策深入分析

以下三個決策直接影響成本和開發複雜度，需要詳細評估。

---

### 決策 A：影片渲染方案選擇

#### 需求說明

**影片渲染是什麼？**
- 將多個素材片段、配音、字幕、配樂「合併」成一個完整的 MP4 影片檔案
- 這個過程叫做「渲染」或「編碼」

**具體要做的事**：
```
輸入：
- 3 個影片片段（seg_001.mp4, seg_015.mp4, seg_023.mp4）
- 1 個配音檔案（voiceover.mp3）
- 1 個配樂檔案（bgm.mp3）
- 字幕資料（JSON 格式，包含文字、時間、樣式）

輸出：
- 1 個完整的短影片（final_output.mp4, 1080x1920, 45秒）
```

**處理步驟**：
1. 將影片片段按時間軸拼接
2. 疊加配音音軌
3. 混合背景音樂（降低音量避免蓋過配音）
4. 在指定時間點顯示字幕（包含動畫效果）
5. 加上轉場特效（淡入淡出、滑動等）
6. 編碼輸出為 MP4 格式

---

#### 方案 A：雲端影片處理 API（全託管）

**運作方式**：
1. 我們把素材、配音、配樂上傳到他們的雲端
2. 呼叫他們的 API，告訴他們要怎麼組合（JSON 格式）
3. 他們的伺服器進行渲染
4. 完成後給我們下載連結

**代表服務**：

**1. Mux Video API**
- 專門做影片處理的服務
- 提供 API 直接組合影片
- 支援字幕、轉場、音軌混合

**收費方式**：
- 影片編碼：$0.005 - $0.01 / 分鐘（輸出影片長度）
- 儲存：$0.01 / GB / 月
- 串流播放：$0.01 / GB（如果要預覽）
- **每支 45 秒影片約 $0.004 - $0.008**

**2. AWS MediaConvert**
- AWS 的影片轉碼服務
- 功能強大，支援各種格式

**收費方式**：
- 基礎 HD 轉碼：$0.015 / 分鐘（輸出影片長度）
- **每支 45 秒影片約 $0.01**

**3. Cloudflare Stream**
- Cloudflare 的影片服務
- 主要是串流播放，編輯功能較少

**收費方式**：
- 儲存：$5 / 1000 分鐘
- **每支 45 秒影片約 $0.004**

---

**方案 A 優點**：
✅ 不用管伺服器（他們幫你處理所有基礎設施）
✅ 自動擴展（再多用戶也不會當機）
✅ 渲染速度快（他們有 GPU 加速）
✅ 開發簡單（呼叫 API 就好）
✅ 不用擔心影片格式相容性

**方案 A 缺點**：
❌ 成本較高（每支影片 $0.004 - $0.01 = NT$0.12 - $0.3）
❌ 功能受限於 API 提供的選項
❌ 依賴外部服務（如果他們漲價或停止服務）
❌ 需要上傳下載（花時間和流量）

**總成本估算（方案 A）**：
- 假設每月生成 1000 支影片
- 每支影片成本：NT$0.2
- **每月成本：NT$200**

---

#### 方案 B：FFmpeg 自架（開源工具）

**運作方式**：
1. 在我們自己的伺服器上安裝 FFmpeg（免費開源軟體）
2. 用戶提交渲染任務後，我們的伺服器執行 FFmpeg 指令
3. FFmpeg 在我們的伺服器上進行渲染
4. 完成後將影片上傳到 S3 給用戶下載

**FFmpeg 是什麼？**
- 免費開源的影片處理工具
- 幾乎所有影片軟體底層都用它（Premiere、Final Cut 底層也是 FFmpeg）
- 非常強大，但需要自己寫指令

**範例 FFmpeg 指令**：
```bash
ffmpeg -i seg_001.mp4 -i seg_015.mp4 -i seg_023.mp4 \
  -i voiceover.mp3 -i bgm.mp3 \
  -filter_complex "[0:v][1:v][2:v]concat=n=3:v=1[outv]; \
                   [3:a][4:a]amix=inputs=2[outa]; \
                   [outv]subtitles=subs.srt[finalv]" \
  -map "[finalv]" -map "[outa]" \
  -c:v libx264 -preset fast -crf 23 \
  output.mp4
```

**部署選項**：

**選項 B1：AWS Lambda + FFmpeg Layer**
- Lambda 是「無伺服器」運算（只在執行時收費）
- 把 FFmpeg 包成 Lambda Layer

**收費方式**：
- Lambda 執行時間：$0.0000166667 / GB-秒
- 假設渲染 45 秒影片需要 30 秒，使用 2GB 記憶體
- 成本：30 秒 × 2GB × $0.0000166667 = $0.001 = NT$0.03
- S3 儲存：幾乎可忽略（< NT$0.01）
- **每支影片約 NT$0.03 - $0.05**

**選項 B2：自己的 VPS 伺服器**
- 租一台伺服器（例如 Hetzner, DigitalOcean）
- 安裝 FFmpeg，用 Node.js/Python 寫渲染服務

**收費方式**：
- 伺服器月租：$5 - $20 / 月（固定成本）
- 不管生成多少影片，成本固定
- **每支影片邊際成本：接近 $0**（只有電費）

**選項 B3：Remotion（React-based）**
- 用 React 寫影片（像寫網頁一樣）
- 底層還是用 FFmpeg，但更好開發

**收費方式**：
- Remotion Lambda（託管版）：$0.0003 / 秒渲染時間
- 45 秒影片約需 60 秒渲染：$0.018 = NT$0.54
- 或自己架，成本同 B1/B2

---

**方案 B 優點**：
✅ 成本極低（每支影片 NT$0.03 - $0.05，或固定月費）
✅ 完全控制（想做什麼特效都可以）
✅ 不依賴外部 API（不怕漲價或停止服務）
✅ 可以優化（針對我們的需求調校）

**方案 B 缺點**：
❌ 開發複雜（要學 FFmpeg 指令或 Remotion）
❌ 需要處理伺服器（部署、監控、擴展）
❌ 渲染速度取決於伺服器規格
❌ 需要處理失敗重試、佇列管理
❌ 影片格式相容性問題要自己解決

**總成本估算（方案 B）**：
- Lambda 方案：每月 1000 支影片 × NT$0.04 = **NT$40**
- VPS 方案：固定月租 NT$150 - $600，**影片成本接近 $0**

---

#### 方案比較總表

| 項目 | 方案 A：雲端 API | 方案 B：FFmpeg 自架 |
|------|-----------------|-------------------|
| **每支影片成本** | NT$0.2 - $0.3 | NT$0.03 - $0.05（Lambda）<br>NT$0（VPS 固定月費） |
| **每月 1000 支成本** | NT$200 - $300 | NT$40（Lambda）<br>NT$150 - $600（VPS 月租） |
| **開發難度** | 🟢 簡單 | 🔴 困難 |
| **開發時間** | 1-2 週 | 3-6 週 |
| **彈性** | 🟡 受限於 API | 🟢 完全控制 |
| **擴展性** | 🟢 自動擴展 | 🟡 需要自己處理 |
| **風險** | 依賴外部服務 | 技術複雜度高 |

---

#### 推薦決策

**前期（100 人規模）**：方案 A（雲端 API - Cloudflare Stream / Mux）
- 理由：
  - 100 人 × 7.5 支/月 = 750 支影片
  - 成本：NT$187/月（完全可接受）
  - 開發時間：1-2 週（比 FFmpeg 省 2 週）
  - 時間價值 > 成本節省（每月省 NT$157 不值得多花 2 週開發）
- **重要**：如果雲端 API 功能不符合需求（例如無法做某些特效），可隨時切換到方案 B

**中期（500-2000 人）**：考慮遷移到方案 B1（Lambda + FFmpeg）
- 成本開始明顯（每月 NT$900 - $1500）
- 產品已驗證成功，值得投資開發時間

**長期（2000+ 人）**：方案 B2（VPS 伺服器）
- 固定月租 NT$150 - $600
- 影片成本接近 $0

---

### 決策 B：用戶認證方案選擇

#### 需求說明

**為什麼一定要做用戶認證？**
1. **素材隔離**：用戶 A 不能看到用戶 B 的影片素材
2. **付費管理**：未來要收費，需要知道誰付了錢
3. **使用量追蹤**：限制免費用戶每月生成幾支影片

**必須做到的功能**：
- 用戶註冊（Email + 密碼）
- 用戶登入
- 登入狀態維護（不用每次都輸入密碼）
- 素材查詢時過濾（只顯示該用戶的素材）

---

#### 方案 A：Supabase Auth（第三方服務）

**Supabase 是什麼？**
- 開源的 Firebase 替代品
- 提供認證、資料庫、儲存一站式服務
- 背後是 PostgreSQL

**運作方式**：
1. 前端使用 Supabase JS SDK
2. 用戶註冊/登入時，呼叫 Supabase API
3. Supabase 回傳 JWT Token
4. 前端把 Token 存在 localStorage
5. 每次 API 請求帶上 Token
6. 後端驗證 Token 是否有效

**程式碼範例**：
```javascript
// 前端 - 註冊
const { user, error } = await supabase.auth.signUp({
  email: 'user@example.com',
  password: 'password123'
})

// 前端 - 登入
const { user, error } = await supabase.auth.signIn({
  email: 'user@example.com',
  password: 'password123'
})

// 前端 - 取得當前用戶
const user = supabase.auth.user()

// 後端 - 驗證 Token
const { data, error } = await supabase.auth.api.getUser(token)
```

**收費方式**：
- 免費額度：50,000 月活躍用戶
- 超過後：$25 / 月（10 萬用戶）
- **前期幾乎免費**

**額外功能**：
- Email 驗證信
- 密碼重設
- OAuth（Google, Facebook 登入）
- 多因素認證（2FA）

---

**方案 A 優點**：
✅ 開發超快（1-3 天就能完成）
✅ 功能齊全（Email 驗證、密碼重設都有）
✅ 前期免費（5 萬用戶內）
✅ 安全性高（他們幫你處理）
✅ 自動處理 Token 更新
✅ 如果用 Supabase 資料庫，整合更簡單

**方案 A 缺點**：
❌ 依賴外部服務（如果 Supabase 掛掉或漲價）
❌ 用戶資料在他們手上（隱私考量）
❌ 長期成本可能較高（大量用戶後）
❌ 功能受限於他們提供的選項

---

#### 方案 B：JWT 自建

**運作方式**：
1. 後端建立用戶表（PostgreSQL）
2. 用戶註冊時，密碼用 bcrypt 加密後存入資料庫
3. 用戶登入時，驗證密碼，產生 JWT Token
4. 前端存 Token，每次請求帶上
5. 後端驗證 Token 有效性

**資料表設計**：
```sql
CREATE TABLE users (
  user_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email VARCHAR(255) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  created_at TIMESTAMP DEFAULT NOW(),
  email_verified BOOLEAN DEFAULT FALSE
);
```

**程式碼範例（Node.js + Express）**：
```javascript
// 註冊
app.post('/api/auth/register', async (req, res) => {
  const { email, password } = req.body
  const passwordHash = await bcrypt.hash(password, 10)

  const user = await db.query(
    'INSERT INTO users (email, password_hash) VALUES ($1, $2) RETURNING *',
    [email, passwordHash]
  )

  res.json({ user })
})

// 登入
app.post('/api/auth/login', async (req, res) => {
  const { email, password } = req.body
  const user = await db.query('SELECT * FROM users WHERE email = $1', [email])

  const valid = await bcrypt.compare(password, user.password_hash)
  if (!valid) return res.status(401).json({ error: 'Invalid password' })

  const token = jwt.sign({ userId: user.user_id }, SECRET_KEY, { expiresIn: '7d' })
  res.json({ token })
})

// 驗證 Token（middleware）
function authMiddleware(req, res, next) {
  const token = req.headers.authorization?.split(' ')[1]
  try {
    const decoded = jwt.verify(token, SECRET_KEY)
    req.userId = decoded.userId
    next()
  } catch (err) {
    res.status(401).json({ error: 'Invalid token' })
  }
}
```

**需要自己實作的功能**：
- Email 驗證信（用 SendGrid / Resend）
- 密碼重設流程
- Token 更新機制（Refresh Token）
- Session 管理
- 安全性處理（防暴力破解、XSS、CSRF）

**收費方式**：
- **開發成本**：0 元（自己寫）
- Email 發送服務：SendGrid 免費額度 100 封/天
- **運行成本：幾乎 $0**

---

**方案 B 優點**：
✅ 完全控制（想做什麼功能都可以）
✅ 不依賴外部服務
✅ 長期成本低（幾乎免費）
✅ 用戶資料在自己手上
✅ 可以針對需求優化

**方案 B 缺點**：
❌ 開發時間長（1-2 週）
❌ 需要自己處理安全性（容易出錯）
❌ 需要維護（密碼重設、Email 驗證等）
❌ 功能較陽春（除非自己加）

---

#### 方案 C：Firebase Auth（另一個第三方選項）

**Firebase 是什麼？**
- Google 的後端服務平台
- 比 Supabase 更成熟，但也更貴

**運作方式**：
- 跟 Supabase 類似
- 但整合 Google 生態系（GCP）

**收費方式**：
- 免費額度：無限用戶（但有其他限制）
- 實際會付費的部分：資料庫讀寫、儲存
- **前期免費，中期可能比 Supabase 貴**

**方案 C 優點**：
✅ 更成熟穩定
✅ 文件齊全
✅ 整合 Google 服務方便

**方案 C 缺點**：
❌ 長期可能較貴
❌ 跟 Supabase 比沒有明顯優勢（除非要用 GCP）

---

#### 方案比較總表

| 項目 | Supabase Auth | JWT 自建 | Firebase Auth |
|------|--------------|---------|---------------|
| **開發時間** | 1-3 天 | 1-2 週 | 1-3 天 |
| **開發難度** | 🟢 簡單 | 🔴 困難 | 🟢 簡單 |
| **前期成本** | 免費 | 免費 | 免費 |
| **長期成本** | 低-中 | 極低 | 中-高 |
| **控制權** | 🟡 受限 | 🟢 完全控制 | 🟡 受限 |
| **安全性** | 🟢 他們處理 | 🟡 自己負責 | 🟢 Google 處理 |
| **功能豐富度** | 🟢 齊全 | 🟡 基本 | 🟢 齊全 |
| **與資料庫整合** | 🟢 完美（如用 Supabase DB） | 🟢 自己設計 | 🟡 需另外處理 |

---

#### 推薦決策

**MVP 階段**：方案 A（Supabase Auth）
- 理由：快速上線最重要
- 3 天 vs 2 週的差異太大
- 前期免費，成本可控
- 如果未來要換，有遷移路徑（匯出用戶資料）

**長期（v2 或 v3）**：
- 如果用戶量很大（> 10 萬）且 Supabase 成本高，考慮遷移到自建
- 但這是「好問題」（代表產品成功了）

**重要提醒**：
- 不管選哪個，資料庫設計要「可遷移」
- 用戶資料結構不要綁死在 Supabase 上
- 保留未來切換的可能性

---

### 決策 C：配樂庫方案選擇

#### 需求說明

**為什麼一定要有配樂？**
- 短影片沒有背景音樂會很單調
- 競爭對手的影片都有配樂
- 音樂可以增加情緒感染力
- 用戶期待是「完整的影片」，不只是素材拼接

**需求清單**：
1. 提供至少 10-20 首背景音樂
2. 根據影片情緒自動選擇（例如：輕鬆、專業、激勵）
3. 避免版權問題（不能隨便用 YouTube 音樂）
4. 音量控制（背景音樂要比配音小聲）

---

#### 方案 A：付費音樂庫訂閱（推薦）

**1. Epidemic Sound**

**是什麼？**
- 專門提供免版權音樂的服務
- YouTuber、創作者常用
- 音樂品質高

**收費方式**：
- Personal 方案：$15 / 月（個人使用）
- Commercial 方案：$49 / 月（商業使用，我們需要這個）
- **我們的情況**：$49 / 月，無限使用

**提供內容**：
- 超過 40,000 首音樂
- 提供 API 可以搜尋、下載
- 有情緒分類（Upbeat, Calm, Dramatic 等）

**如何整合**：
```javascript
// 1. 從 Epidemic Sound API 搜尋音樂
const music = await epidemicSound.search({
  mood: 'upbeat',
  duration: '30-60',
  genre: 'electronic'
})

// 2. 下載音樂檔案
const audioFile = await epidemicSound.download(music.id)

// 3. 在渲染時加入背景音樂
```

---

**2. Artlist**

**是什麼？**
- 另一個熱門音樂庫
- 音樂更偏電影感、專業

**收費方式**：
- Music & SFX 方案：$299 / 年 = $25 / 月
- **包含無限下載**

**提供內容**：
- 約 20,000 首音樂
- 高品質（很多用於廣告、短片）

---

**3. Uppbeat**

**是什麼？**
- 免費音樂庫（有條件）
- 針對 YouTuber

**收費方式**：
- 免費方案：每月 10 首（需在影片中標註來源）
- Premium：$9.99 / 月（無限使用，不用標註）

**提供內容**：
- 約 15,000 首
- 品質中等

---

**方案 A 總結**：

| 服務 | 月費 | 曲庫大小 | 品質 | API |
|------|------|----------|------|-----|
| Epidemic Sound | $49 | 40,000+ | 🟢 高 | ✅ |
| Artlist | $25 | 20,000+ | 🟢 高 | ❌（手動下載） |
| Uppbeat | $10 | 15,000+ | 🟡 中 | ❌ |

**方案 A 優點**：
✅ 音樂品質高
✅ 完全合法（版權問題他們處理）
✅ 曲庫大，選擇多
✅ 持續更新（每月新曲）
✅ 有情緒分類，方便 AI 選擇

**方案 A 缺點**：
❌ 每月固定成本（$25 - $49）
❌ 如果停止付費，不能再使用之前的音樂
❌ 依賴外部服務

**成本分析**：
- 假設選 Artlist：$25 / 月
- 如果每月生成 1000 支影片
- **每支影片配樂成本：$0.025 = NT$0.75**

---

#### 方案 B：免費音樂庫（CC0 / Public Domain）

**1. YouTube Audio Library**

**是什麼？**
- YouTube 官方提供的免費音樂
- 完全免費使用

**收費方式**：
- **免費**

**提供內容**：
- 約 1,500 首音樂
- 品質參差不齊
- 沒有 API（需手動下載）

**如何使用**：
1. 手動從 YouTube Audio Library 下載 100 首音樂
2. 上傳到我們的 S3
3. 自己做分類（標註情緒、風格）
4. 在渲染時隨機或根據情緒選擇

---

**2. Free Music Archive**

**是什麼？**
- 開放授權音樂資料庫
- 大部分是 CC-BY（需標註來源）

**收費方式**：
- **免費**

**提供內容**：
- 數千首音樂
- 品質不一

---

**3. Pixabay Music**

**是什麼？**
- 圖片網站 Pixabay 也提供免費音樂
- CC0 授權（完全免費使用）

**收費方式**：
- **免費**

**提供內容**：
- 約 20,000 首
- 品質中等

**是否有 API**：
- ✅ 有 API 可以搜尋和下載

**如何整合**：
```javascript
// Pixabay Music API
const response = await fetch(
  'https://pixabay.com/api/music/?key=YOUR_KEY&q=upbeat'
)
const music = await response.json()
```

---

**方案 B 總結**：

| 服務 | 費用 | 曲庫大小 | 品質 | API | 授權 |
|------|------|----------|------|-----|------|
| YouTube Audio Library | 免費 | 1,500 | 🟡 中 | ❌ | ✅ 免費 |
| Pixabay Music | 免費 | 20,000 | 🟡 中 | ✅ | ✅ CC0 |
| Free Music Archive | 免費 | 數千 | 🟡 中 | ❌ | 🟡 需標註 |

**方案 B 優點**：
✅ 完全免費
✅ 不依賴付費服務
✅ 永久使用（不用擔心停止訂閱）

**方案 B 缺點**：
❌ 音樂品質不如付費庫
❌ 選擇較少
❌ 需要自己做分類和管理
❌ 可能有版權風險（需仔細檢查每首曲子的授權）

**成本分析**：
- 開發成本：需要花時間篩選音樂、分類、上傳
- **每支影片配樂成本：$0**

---

#### 方案 C：混合模式（推薦）

**運作方式**：
1. **免費方案**：使用 Pixabay Music API（20 首精選）
2. **付費方案**：訂閱 Artlist，提供更多高品質音樂

**收費策略**：
- 免費用戶：只能用 Pixabay 的 20 首音樂（品質 OK，但選擇少）
- 付費用戶：可以用 Artlist 的 20,000 首音樂（品質高）

**成本分析**：
- Artlist：$25 / 月
- 假設 20% 用戶付費，每月 200 個付費用戶
- 每個用戶收費 $5 / 月（NT$150）
- **收入：$1000 / 月，成本：$25 / 月，淨賺 $975**

---

**方案 C 優點**：
✅ MVP 可以免費啟動（用 Pixabay）
✅ 付費方案可以創造差異化（高品質音樂）
✅ 成本可控（只在有付費用戶時才訂閱 Artlist）

**方案 C 缺點**：
❌ 需要整合兩套系統
❌ 免費音樂品質可能影響用戶體驗

---

#### 方案比較總表

| 項目 | 方案 A：付費庫 | 方案 B：免費庫 | 方案 C：混合 |
|------|---------------|---------------|-------------|
| **每月成本** | $25 - $49 | $0 | $0 - $25 |
| **音樂品質** | 🟢 高 | 🟡 中 | 🟢 高（付費）🟡 中（免費） |
| **曲庫大小** | 20,000+ | 1,500 - 20,000 | 分級提供 |
| **開發難度** | 🟢 簡單 | 🟡 中等 | 🟡 中等 |
| **版權風險** | 🟢 無 | 🟡 需檢查 | 🟢 無 |
| **商業模式** | 成本壓力 | 無成本 | 創造付費價值 |

---

#### 推薦決策

**MVP 階段**：方案 B（Pixabay Music）
- 理由：
  - 完全免費，降低初期成本
  - 有 API，整合簡單
  - 20,000 首曲庫夠用
  - 精選 20-30 首高品質音樂就能啟動

**長期**：方案 C（混合模式）
- 免費用戶：Pixabay 音樂（20 首精選）
- 付費用戶：Artlist / Epidemic Sound（完整曲庫）
- 創造付費誘因

**實作步驟**：
1. 從 Pixabay 篩選 20 首高品質音樂
2. 手動分類（Upbeat, Calm, Professional, Dramatic）
3. 上傳到 S3，建立音樂資料表
4. AI 根據影片情緒選擇音樂
5. 未來如果有預算，再訂閱 Artlist

---

## 三大決策總結

### 方案 A：前期規模（100 人）- 快速上線策略

| 決策 | 推薦方案 | 每月總成本（750 支） | 開發時間 |
|------|---------|---------------------|---------|
| 影片渲染 | 雲端 API（Cloudflare Stream） | NT$187 | 1-2 週 |
| 用戶認證 | Supabase Auth | NT$0 | 1-3 天 |
| 配樂庫 | Pixabay Music（免費） | NT$0 | 3-5 天 |
| **總計** | - | **NT$187/月** | **2-3 週** |

**方案特點**：
✅ 最快上線（2-3 週 vs 4-6 週）
✅ 成本可接受（NT$187/月）
✅ 降低技術風險
✅ 專注核心功能（智能選片）
⚠️ **如果雲端 API 功能不足，可隨時切換到 FFmpeg**

---

### 方案 B：成長規模（500+ 人）- 成本優化策略

| 決策 | 推薦方案 | 每月總成本 | 開發時間 |
|------|---------|-----------|---------|
| 影片渲染 | FFmpeg + Lambda | NT$40 - $150 | 3-4 週（遷移） |
| 用戶認證 | Supabase Auth | NT$0 - $25 | - |
| 配樂庫 | Pixabay + Artlist 混合 | NT$0 - $750 | - |
| **總計** | - | **NT$40 - $925/月** | - |

**何時切換**：
- 當每月成本 > NT$1000 時
- 且產品已驗證成功
- 值得投資開發時間降低成本

---

### 推薦採用：方案 A（前期快速上線）

**核心邏輯**：
- 在 100 人規模下，時間 > 成本
- 省 2 週開發時間，可更快驗證產品
- 每月 NT$187 的成本差異微不足道
- 成功後再優化成本

---

## 完成檢查

- [x] 清楚定義了「我們做」vs「外部服務」的界線
- [x] 列出了必須整合的外部服務清單
- [x] 評估了成本與風險
- [x] 做出了關鍵的技術邊界決策
- [x] 詳細分析了三大關鍵決策（影片渲染、用戶認證、配樂庫）

**完成後**：更新 `00-INDEX.md` 狀態，繼續步驟 4
