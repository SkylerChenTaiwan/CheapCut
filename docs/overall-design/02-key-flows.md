# 步驟 2：關鍵流程設計

**狀態**：✅ 已完成
**前置依賴**：01-product-core.md
**目標**：畫出主要的使用流程

---

## 流程一：素材管理流程

### 流程圖

```
用戶上傳影片素材
  ↓
系統分析影片內容
  ↓
自動打 tag/分類
  ↓
用戶瀏覽/管理素材庫
  ↓
素材庫建立完成
```

---

### 詳細步驟拆解

#### 階段 1：上傳素材
**用戶做什麼**：
- 選擇並上傳影片檔案（可能一次上傳多支）

**系統做什麼**：
- 接收影片檔案
- 驗證檔案格式、大小
- 上傳到儲存空間

**產出**：
- 影片檔案儲存在系統中

**預計耗時**：
- 依檔案大小，1-5 分鐘

---

#### 階段 2：影片分析
**輸入**：
- 已上傳的影片檔案

**處理邏輯**：
- 影片內容分析（場景、人物、動作、情緒等）
- 自動切分片段（找出可用的片段）
- 生成縮圖

**產出**：
- 影片分析結果（metadata）
- 自動切分的片段列表
- 每個片段的縮圖

**預計耗時**：
- 每支影片 30 秒 - 2 分鐘

---

#### 階段 3：自動標記
**輸入**：
- 影片分析結果

**處理邏輯**：
- 根據分析結果自動打 tag（例如：「特寫」、「產品展示」、「說話」等）
- 分類片段類型
- 將資料寫入資料庫

**資料庫設計**：
使用三張表的結構：

1. **videos 表**（原始影片）
   - video_id：影片 ID
   - file_path：檔案路徑
   - upload_time：上傳時間
   - user_id：用戶 ID

2. **segments 表**（片段資訊）
   - segment_id：片段 ID
   - video_id：所屬影片 ID（外鍵）
   - start_time：開始時間
   - end_time：結束時間
   - description：片段描述（AI 生成的文字說明）
   - thumbnail_url：縮圖位置

3. **segment_tags 表**（片段與標籤的多對多關聯）
   - segment_id：片段 ID（外鍵）
   - tag：標籤名稱
   - （可選）tag_type：標籤類型（視覺/內容/情緒等）
   - （可選）confidence：信心分數

**產出**：
- 帶有標籤的素材片段（存入資料庫）
- 完整的影片不會被切分，保留原始檔案
- 片段資訊以 metadata 形式存在資料庫中

**預計耗時**：
- 幾秒鐘

---

#### 階段 4：用戶瀏覽管理
**用戶做什麼**：
- 瀏覽已上傳的素材
- 查看自動生成的標籤
- 可選：手動調整標籤或刪除不要的片段

**系統做什麼**：
- 提供素材瀏覽介面
- 顯示縮圖、標籤、時長等資訊

**產出**：
- 整理好的素材庫

**用戶體驗**：
- 可以隨時回來新增或管理素材

---

## 流程二：影片生成流程

### 流程圖

```
用戶提供配音內容
  ↓
系統理解配音/腳本
  ↓
從素材庫挑選適合片段
  ↓
用戶確認/調整素材選擇
  ↓
自動剪輯、配樂、加字幕
  ↓
影片輸出
```

---

### 詳細步驟拆解

#### 階段 1：配音輸入
**用戶做什麼**：
- 選項 A：直接在系統上錄音
- 選項 B：上傳事先錄好的音檔
- 選項 C：輸入文字腳本（系統生成 AI 配音）

**系統做什麼**：
- 接收音檔或文字
- 如果是文字，使用 TTS 生成配音
- 儲存配音檔案

**產出**：
- 配音音檔

**預計耗時**：
- 錄音：用戶自行控制
- TTS 生成：10-30 秒

---

#### 階段 2：內容理解
**輸入**：
- 配音音檔

**處理邏輯**：
- 語音轉文字（STT）
- 分析內容語意（哪些段落在講什麼）
- 標記重點關鍵字

**產出**：
- 文字腳本
- 時間軸標記（每句話的時間點）
- 內容語意分析結果

**預計耗時**：
- 30 秒 - 1 分鐘

---

#### 階段 3：智能選片

**輸入**：
- 配音的內容語意分析（文字腳本 + 時間軸標記）
- 用戶的素材庫（資料庫中的 segments 和 tags）

---

##### 子步驟 3.1：配音切分

**目標**：將配音切分成有變化、有節奏的片段

**AI 處理邏輯**：
- 分析配音的語意結構（句子、停頓、語氣轉折）
- 切分成不同長度的片段

**切分原則**：
- ✅ 根據語意自然切分
- ✅ **片段長度要有變化**（避免整部影片都是相同長度）
  - 重要內容：5-12 秒
  - 轉場/停頓：1-3 秒
  - 一般說明：3-8 秒
- ❌ 避免切得太碎（最短不低於 1 秒）

**範例**：
```
配音總長 45 秒，切分結果：
┌────────────────────────────────────┐
│ 片段 1 (0-8秒)：「大家好，今天要介紹...」  │ 8秒 - 開場
│ 片段 2 (8-10秒)：（停頓）                │ 2秒 - 轉場
│ 片段 3 (10-22秒)：「這個產品有三大特色...」│ 12秒 - 重點
│ 片段 4 (22-25秒)：「第一個特色是...」     │ 3秒 - 過渡
│ 片段 5 (25-35秒)：「我們的客戶反饋...」   │ 10秒 - 案例
│ 片段 6 (35-40秒)：「總結來說...」        │ 5秒 - 總結
│ 片段 7 (40-45秒)：「歡迎聯繫我們」       │ 5秒 - CTA
└────────────────────────────────────┘
```

**產出**：
- 配音片段清單（每個片段有起始時間、結束時間、語意描述）

---

##### 子步驟 3.2：為每個片段搜尋候選素材

**目標**：為每個配音片段找出適合的素材候選

**處理流程**：

**1. AI 提取每個片段的關鍵字/tags**
```
片段 1（開場）：tags = ["介紹", "開場", "正面"]
片段 3（重點）：tags = ["產品", "特寫", "功能"]
片段 5（案例）：tags = ["客戶", "見證", "使用"]
```

**2. 資料庫搜尋候選片段**

對每個配音片段執行查詢：
```sql
SELECT segments.*,
       GROUP_CONCAT(segment_tags.tag) as matched_tags,
       COUNT(segment_tags.tag) as match_count
FROM segments
JOIN segment_tags ON segments.segment_id = segment_tags.segment_id
WHERE segment_tags.tag IN ('產品', '特寫', '功能')
  AND segments.end_time - segments.start_time >= [需要的最短長度]
GROUP BY segments.segment_id
ORDER BY match_count DESC
LIMIT 20
```

**3. 過濾規則**：
- 只顯示「長度足夠」的素材（素材長度 ≥ 配音片段長度的 80%）
- 如果素材太長，可以被裁切使用（從 25% 位置開始取）

**產出**：
- 每個配音片段都有 10-20 個候選素材清單

---

##### 子步驟 3.3：AI 選片與組合

**目標**：像導演一樣，為整支影片選擇最佳的素材組合

**AI 決策邏輯**：

**1. 為每個片段選擇素材**
- 從候選清單中挑選最適合的素材
- 考慮語意匹配、視覺效果、情緒一致性

**2. 素材使用規則**：

✅ **允許的做法**：
- **素材可以被裁切**：取素材的某個時間段
  ```
  配音片段需要 5 秒
  → 使用 seg_001（8秒長）
  → 從 25% 位置開始取 5 秒（2-7秒）
  ```

- **一個配音片段可以用多個素材填充**
  ```
  配音片段 3（12 秒）：
  → seg_001 (0-5秒) + seg_015 (5-9秒) + seg_023 (9-12秒)
  ```

- **素材可以間隔後再使用**
  ```
  片段1: seg_001
  片段2: seg_015
  片段3: seg_023
  片段4: seg_001 ← OK（中間隔了兩個片段）
  ```

- **素材可以用慢動作**（0.9x-0.95x）
- **素材可以循環播放**（如果合適，例如：風景、產品旋轉）

❌ **需要避免的錯誤**：
- **連續重複同一素材**
  ```
  ❌ 片段1: seg_001
     片段2: seg_001
     片段3: seg_001
  ```
- **過度使用同一素材**（整支影片 > 70% 都是同一素材）
- **不自然的頻繁切換**（< 1 秒就換畫面）

**3. 整體檢查（導演視角）**

AI 完成選片後自我檢查：
- ✅ 整體節奏是否自然？
- ✅ 畫面是否有足夠變化？
- ✅ 是否避免了過度重複？
- ✅ 重要內容是否有合適畫面？
- ❌ 如果無法做出合理影片 → 回報「素材不足」

---

##### AI Prompt 設計要點

```
角色：你是一位專業的短影片導演

任務：為這段配音選擇素材並組合成影片

步驟：
1. 將配音切分成有變化的片段（長度 1-12 秒不等）
2. 為每個片段選擇最合適的素材
3. 確保整體畫面流暢、有節奏感

規則：
✅ 允許：
  - 裁切素材（取部分時間段）
  - 一個片段用多個素材組合
  - 素材間隔後再使用
  - 慢動作或循環播放（需自然）

❌ 避免：
  - 連續使用同一素材
  - 過度重複某個素材
  - 畫面切換過於頻繁

如果素材不足以做出合理影片，回報：「素材不足」
```

---

**產出**：
- 完整的影片時間軸（每個時間段對應的 segment_id + 裁切資訊）
- 或「素材不足」提示

**預計耗時**：
- 配音切分：5-10 秒
- 資料庫搜尋：< 1 秒
- AI 選片與組合：15-40 秒
- **總計**：20-50 秒

---

#### 階段 4：時間軌預覽與片段調整

**核心概念**：
- **配音音軌是主軸**：決定影片長度和節奏
- 系統根據配音自動分段，為每個段落填充影片片段、字幕、配樂
- 用戶看到的是「暫存草稿」，可以調整後再正式合成

**介面設計：時間軌編輯器**
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【主軸：配音音軌】
00:00 ─────────┬─────────┬─────────┬──────── 00:45
            句子1      句子2      句子3
            (5秒)     (8秒)      (10秒)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【影片軌】
[seg_001] [seg_015] [seg_023]
  5秒       8秒       10秒

【字幕軌】
[句子1字幕][句子2字幕][句子3字幕]

【配樂軌】
[========= 背景音樂 =========]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
[預覽播放] [確認生成]
```

**允許的操作**：
- ✅ 替換影片片段
- ✅ 替換字幕樣式
- ✅ 替換配樂
- ✅ 預覽播放

**暫不支援**：
- ❌ 剪輯配音
- ❌ 調整配音長度
- ❌ 改變段落順序
- ❌ 刪除/新增段落

---

##### 片段替換 UI 設計

**操作流程**：
1. 用戶點擊時間軌上的某個影片片段
2. 彈出「替換片段介面」
3. 用戶選擇新片段（可預覽）
4. 系統替換並更新預覽

**替換介面架構**：
```
┌─────────────────────────────────────┐
│ 替換這個片段 (需要 5 秒)              │
├─────────────────────────────────────┤
│ 篩選: □ 產品 □ 特寫 □ 說話 □ 專業   │
├─────────────────────────────────────┤
│ ┌───────┐ ┌───────┐ ┌───────┐      │
│ │[縮圖] │ │[縮圖] │ │[縮圖] │      │
│ │ 8秒   │ │ 7秒   │ │ 6秒   │      │
│ │#產品  │ │#特寫  │ │#說話  │      │
│ └───────┘ └───────┘ └───────┘      │
│                                     │
│ ┌───────┐ ┌───────┐                │
│ │[縮圖] │ │[縮圖] │                │
│ │ 9秒   │ │ 5秒   │   [看更多...]  │
│ │#專業  │ │#產品  │                │
│ └───────┘ └───────┘                │
└─────────────────────────────────────┘
```

**候選片段顯示邏輯**：
- 一開始顯示 5-10 個符合長度的片段（隨機）
- 提供「看更多」按鈕展開更多選項
- 提供 Tag 篩選器

**每個候選片段顯示**：
- 縮圖
- 片段長度
- Tags

**互動方式**：
- 點擊候選片段 → 預覽播放
- 確認 → 替換到時間軌

---

##### 片段長度匹配規則

**如果素材長度 > 需要的長度**：
- 從素材的 **25% 位置**開始取
- 取出需要的長度
- 範例：需要 5 秒，素材有 8 秒
  ```
  [==25%==|=====5秒=====|==]
    0-2秒   2-7秒      7-8秒
           ↑ 起點
  ```

**如果素材長度 < 需要的長度**：
- ❌ 不顯示在候選清單中
- 用戶只能看到「長度足夠」的片段

**產出**：
- 用戶調整後的片段清單（暫存草稿）

**預計耗時**：
- 取決於用戶調整時間

---

#### 階段 5：自動剪輯合成
**輸入**：
- 配音音檔
- 選定的素材片段
- 文字腳本（用於字幕）

**處理邏輯**：
- 將素材片段按時間軸組合
- 加上配音
- 自動生成字幕
- 加上背景音樂
- 加上轉場特效
- 調整節奏

**產出**：
- 完成的影片檔案（MP4）

**預計耗時**：
- 1-3 分鐘

---

#### 階段 6：交付
**輸入**：
- 完成的影片

**處理邏輯**：
- 生成下載連結

**產出**：
- 可下載的影片檔案

**用戶體驗**：
- 下載影片到本地
- （未來）可直接發布到社群平台

---

## 異常流程

### 流程一：素材管理流程的異常

#### 異常 1-1：影片上傳失敗
**觸發條件**：
- 檔案太大（> 250MB）
- 格式不支援（非 MP4/MOV）
- 網路中斷

**處理方式**：
- 顯示明確的錯誤訊息（例如：「檔案過大，請壓縮後重新上傳」）
- 允許用戶重新上傳
- 提供格式轉換建議

---

#### 異常 1-2：影片分析失敗
**觸發條件**：
- 影片檔案損壞
- 編碼格式特殊（AI 無法處理）
- AI 分析 API 錯誤或超時

**處理方式**：
- 標記該影片為「分析失敗」
- 提供「重試」按鈕
- 允許用戶手動為影片打 tag（繞過自動分析）
- 影片仍然可以在素材庫中使用

---

#### 異常 1-3：無法生成縮圖
**觸發條件**：
- 影片無視訊軌（純音訊）
- 編碼問題導致無法截圖

**處理方式**：
- 使用系統預設縮圖（placeholder）
- 在素材上標記警告圖示
- 不影響影片的正常使用

---

### 流程二：影片生成流程的異常

#### 異常 2-1：配音處理失敗
**觸發條件**：
- **STT（語音轉文字）失敗**：
  - 音質太差、背景噪音過大
  - 口音太重、語速過快
  - 語音辨識 API 錯誤
- **語音辨識錯誤率過高**：
  - STT API 返回的 confidence score 過低
  - 例如：超過 30% 的詞信心分數 < 0.6

**處理方式**：

**方案 A：系統自動判斷 + 用戶確認**
1. 系統顯示辨識結果給用戶檢查
2. 如果信心分數低，顯示警告：「語音辨識可能不準確，請檢查」
3. 提供選項：
   - 「重新錄音」
   - 「上傳文字稿」（系統用文字稿與音軌對齊）
   - 「繼續使用」（用戶覺得可以接受）

**方案 B：用戶自主判斷**
- 無論如何都顯示辨識結果
- 用戶自己決定是否接受
- 提供「上傳文字稿」選項

**採用方案**：混合（方案 A）
- 系統用信心分數做基本檢查
- 但最終由用戶決定

---

#### 異常 2-2：素材不足
**觸發條件**：
- **用戶素材庫是空的**
- **沒有符合長度要求的片段**（所有素材都太短）
- **Tag 搜尋沒有匹配結果**（語意完全不相關）
- **AI 判斷無法做出合理影片**：
  - 在「智能選片 - 子步驟 3.3」的整體檢查中
  - AI 發現素材太少或太單一，無法組合出有變化、流暢的影片

**處理方式**：

**1. 事前預警**（配音上傳後）：
```
⚠️ 提示：
配音長度：45 秒
可用素材總時長：20 秒
建議上傳更多素材以獲得更好的效果
```

**2. 選片階段發現問題**：
```
❌ 素材不足
您的素材庫內容太少，無法為這段配音生成影片

建議：
- 上傳更多影片素材（建議至少 60 秒）
- 重新錄製較短的配音
- 增加不同類型的素材（目前只有產品特寫）
```

**3. 部分素材不足**：
- 如果只是某幾個片段找不到合適素材
- 系統可以提示：「第 3 段配音缺少『客戶見證』相關素材」
- 讓用戶選擇：上傳相關素材 或 修改配音內容

---

#### 異常 2-3：字幕生成失敗
**觸發條件**：
- 語音辨識錯誤率過高（與異常 2-1 相同）
- 語言不支援
- STT API 失敗

**處理方式**：

**主要方案：允許用戶上傳文字稿**

**操作流程**：
1. 系統顯示「字幕生成失敗」或「辨識結果不理想」
2. 提供「上傳文字稿」選項
3. 用戶上傳完整的文字稿（純文字檔或直接貼上）
4. 系統使用 **forced alignment** 技術：
   - 將文字稿的每個句子/詞對應到音軌的時間點
   - 生成帶時間軸的字幕

**如果對齊失敗**：
- 使用簡單的平均分配：
  - 配音總長度 ÷ 句子數 = 每句平均時長
  - 按順序分配時間軸
- 提示用戶：「字幕時間軸為自動分配，可能不完全準確」

**額外功能：時間軌階段手動修改字幕**
- 在「階段 4：時間軌預覽」時
- 用戶可以點擊字幕軌上的任何一段字幕
- 直接修改文字內容
- 不改變時間軸（時間由配音決定）

---

#### 異常 2-4：影片合成失敗
**觸發條件**：
- 編碼錯誤
- 伺服器記憶體不足
- 處理超時（超過 5 分鐘）
- 第三方 API（配樂、特效）失敗

**處理方式**：
1. **自動重試**：系統自動重試 1-2 次
2. **降級處理**：
   - 降低影片品質（1080p → 720p）
   - 移除部分特效
   - 使用更簡單的轉場
3. **通知用戶**：
   - 如果重試失敗，顯示明確錯誤訊息
   - 提供「重新生成」選項
   - 或讓用戶聯繫客服

---

#### 異常 2-5：配音與素材長度嚴重不匹配
**觸發條件**：
- 配音太長（例如 3 分鐘），但素材總長度不夠（例如 1 分鐘）
- 超出 AI 可合理處理的範圍

**處理方式**：

**事前檢查**（配音上傳後立即計算）：
```
⚠️ 配音長度警告
配音長度：180 秒
可用素材總長度：60 秒

建議：
- 重新錄製較短的配音（建議 < 90 秒）
- 上傳更多素材片段
```

**容許範圍**：
- 如果只差一點點（例如 5-10 秒或配音長度的 10% 以內）
- AI 可以用慢動作、循環播放、重複片段等方式處理
- 由 AI 自行判斷如何處理最自然

**超出範圍**：
- 強制要求用戶處理（無法繼續生成）

---

## 流程總結

### 流程一：素材管理流程 - 時間估算

| 階段 | 預計耗時 |
|------|----------|
| 階段 1：上傳素材 | 1-5 分鐘（依檔案大小） |
| 階段 2：影片分析 | 30 秒 - 2 分鐘 |
| 階段 3：自動標記 | < 10 秒 |
| 階段 4：用戶瀏覽管理 | 用戶自行決定 |
| **總計（單支影片）** | **約 2-7 分鐘** |

**瓶頸分析**：
- **最慢環節**：影片上傳（受網路速度影響）
- **優化方向**：
  - 支援斷點續傳
  - 壓縮影片後上傳
  - 背景處理影片分析（上傳完就可以離開）

---

### 流程二：影片生成流程 - 時間估算

| 階段 | 預計耗時 |
|------|----------|
| 階段 1：配音輸入 | 用戶錄音時間（自行控制） |
| 階段 2：內容理解（STT） | 30 秒 - 1 分鐘 |
| 階段 3：智能選片 | 20-50 秒 |
| 階段 4：時間軌預覽與調整 | 用戶自行決定（可選） |
| 階段 5：自動剪輯合成 | 1-3 分鐘 |
| 階段 6：交付 | < 10 秒 |
| **總計（45 秒影片）** | **約 2-5 分鐘**（不含用戶操作時間） |

**瓶頸分析**：
- **最慢環節**：自動剪輯合成（影片渲染）
- **優化方向**：
  - 使用更快的編碼器（硬體加速）
  - 預先處理素材（提前轉碼）
  - 異步處理 + 通知機制

---

### 最差情況時間估算

**假設所有 API 都慢到上限、網路緩慢、影片較長（90 秒）**

#### 流程一：素材管理（單支影片）

| 階段 | 最差情況耗時 |
|------|-------------|
| 階段 1：上傳素材 | 10 分鐘（大檔案 + 慢網路） |
| 階段 2：影片分析 | 5 分鐘（API 慢、影片長） |
| 階段 3：自動標記 | 30 秒 |
| **最差總計** | **約 15-16 分鐘** |

#### 流程二：影片生成（90 秒影片）

| 階段 | 最差情況耗時 |
|------|-------------|
| 階段 2：內容理解 | 2 分鐘（STT API 慢） |
| 階段 3：智能選片 | 1.5 分鐘（AI 運算慢） |
| 階段 5：自動剪輯合成 | 8 分鐘（渲染慢、特效多） |
| 階段 6：交付 | 30 秒 |
| **最差總計** | **約 12 分鐘** |

---

### 用戶體驗影響與應對策略

**用戶體驗影響**：
- 如果整個流程超過 10 分鐘，用戶可能會感到不耐煩
- 在最差情況下（素材上傳 + 影片生成），可能需要 25-30 分鐘

**應對策略**：

✅ **已決定採用的策略**：
- [x] **進度條顯示**：讓用戶知道目前處理到哪裡
- [x] **時間預估提示**：「預計還需 2 分鐘」
- [x] **階段性完成通知**：「影片分析完成」、「選片完成」
- [x] **背景處理**：
  - 素材上傳後可以離開，系統背景分析
  - 影片生成時可以在時間軌調整階段離開，確認後背景合成

⏭️ **未來可考慮**：
- [ ] 異步處理 + Email/推播通知
- [ ] 超時自動重試機制
- [ ] 降級處理（降低品質以加快速度）

---

## 關鍵決策記錄

### 決策 1：預覽機制
**決定**：✅ 提供時間軌預覽與調整功能
- 用戶可以在「階段 4：時間軌預覽」看到 AI 自動生成的結果
- 可以替換影片片段、字幕、配樂
- 確認後才進入最終合成

### 決策 2：重新生成策略
**決定**：✅ 支援兩種方式
- **局部調整**：在時間軌介面替換素材、修改字幕（主要方式）
- **完全重新生成**：用戶可以選擇「放棄」並重新開始整個流程

### 決策 3：同步 vs 異步
**決定**：✅ 混合模式
- **同步**：智能選片、內容理解（等待時間短，< 1 分鐘）
- **異步（背景處理）**：
  - 素材上傳與分析
  - 影片合成（用戶確認時間軌後）
- 提供進度條和時間預估

---

**完成檢查**：
- [x] 畫出完整的兩個主要流程（素材管理、影片生成）
- [x] 每個階段的輸入輸出明確
- [x] 定義了詳細的異常處理流程
- [x] 做出了關鍵的流程決策
- [x] 完成時間估算與瓶頸分析
- [x] 設計了智能選片的詳細邏輯
- [x] 設計了時間軌預覽與 UI 互動

**完成後**：更新 `00-INDEX.md` 狀態，繼續步驟 3
