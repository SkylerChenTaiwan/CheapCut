# 步驟 4:模組初步拆解

**狀態**：🔄 討論中
**前置依賴**：01-product-core.md, 02-key-flows.md, 03-system-boundary.md
**目標**：將 CheapCut 系統拆解成明確的模組，定義各自職責與邊界

---

## 模組拆解總覽

根據前面的產品定義、關鍵流程與系統邊界分析，CheapCut 系統可拆解為以下核心模組：

```
┌──────────────────────────────────────────────────────────────────┐
│                         CheapCut 系統                             │
├──────────────────────────────────────────────────────────────────┤
│                                                                    │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                      前端層 (Frontend)                       │ │
│  │                                                               │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │ │
│  │  │ 1. 素材管理  │  │ 2. 錄音/配音 │  │ 3. 時間軌編輯│      │ │
│  │  │   模組       │  │    模組      │  │    模組      │      │ │
│  │  └──────────────┘  └──────────────┘  └──────────────┘      │ │
│  │                                                               │ │
│  │  ┌──────────────┐  ┌──────────────┐                        │ │
│  │  │ 4. 用戶介面  │  │ 5. 用戶認證  │                        │ │
│  │  │   核心模組   │  │    模組      │                        │ │
│  │  └──────────────┘  └──────────────┘                        │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                             ↕ API                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                     後端層 (Backend)                         │ │
│  │                                                               │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │ │
│  │  │ 6. 素材處理  │  │ 7. 配音處理  │  │ 8. 智能選片  │      │ │
│  │  │   引擎       │  │   引擎       │  │   引擎       │      │ │
│  │  └──────────────┘  └──────────────┘  └──────────────┘      │ │
│  │                                                               │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │ │
│  │  │ 9. 影片合成  │  │ 10. API 服務 │  │ 11. 資料管理 │      │ │
│  │  │   引擎       │  │    層        │  │    模組      │      │ │
│  │  └──────────────┘  └──────────────┘  └──────────────┘      │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                             ↕ 資料                                │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                  資料與儲存層 (Data & Storage)               │ │
│  │                                                               │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │ │
│  │  │ 12. 資料庫   │  │ 13. 檔案儲存 │  │ 14. 快取層   │      │ │
│  │  │   (PostgreSQL)│  │   (S3/R2)    │  │   (Redis)    │      │ │
│  │  └──────────────┘  └──────────────┘  └──────────────┘      │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                             ↕ API                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    外部服務層 (External)                     │ │
│  │                                                               │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │ │
│  │  │ 15. 影片分析 │  │ 16. 語音處理 │  │ 17. AI 服務  │      │ │
│  │  │   服務       │  │   服務       │  │   整合       │      │ │
│  │  └──────────────┘  └──────────────┘  └──────────────┘      │ │
│  │                                                               │ │
│  │  ┌──────────────┐  ┌──────────────┐                        │ │
│  │  │ 18. 配樂服務 │  │ 19. 影片渲染 │                        │ │
│  │  │   整合       │  │   服務       │                        │ │
│  │  └──────────────┘  └──────────────┘                        │ │
│  └─────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────┘
```

---

## 模組詳細定義

### 前端層 (Frontend)

---

#### 模組 1：素材管理模組

**職責**：
- 素材上傳介面
- 素材瀏覽與篩選
- 素材預覽
- 素材標籤編輯
- 素材刪除

**核心功能**：
1. 多檔案上傳（支援拖拉）
2. 上傳進度顯示
3. 素材卡片展示（縮圖、標籤、時長）
4. 標籤篩選器
5. 素材預覽播放器

**對應流程**：
- 流程一：素材管理流程（階段 1、階段 4）

**技術需求**：
- 檔案上傳（分片上傳、斷點續傳）
- 影片預覽播放器
- 拖拉排序 UI

**對外介面**：
- API：上傳素材、查詢素材列表、更新標籤、刪除素材
- 與「素材處理引擎」互動

---

#### 模組 2：錄音/配音模組

**職責**：
- 網頁錄音功能
- 音檔上傳
- 配音預覽播放
- 文字腳本輸入（未來可能支援）

**核心功能**：
1. 瀏覽器錄音（Web Audio API）
2. 錄音波形顯示
3. 錄音重錄
4. 音檔上傳
5. 配音播放器

**對應流程**：
- 流程二：影片生成流程（階段 1）

**技術需求**：
- Web Audio API（錄音）
- 音訊波形可視化
- 音檔格式轉換（前端或後端）

**對外介面**：
- API：上傳配音檔案
- 與「配音處理引擎」互動

---

#### 模組 3：時間軌編輯模組

**職責**：
- 時間軌視覺化
- 片段預覽
- 片段替換
- 字幕編輯
- 配樂選擇
- 影片預覽播放

**核心功能**：
1. 時間軌 UI 渲染（配音軌、影片軌、字幕軌、配樂軌）
2. 片段替換介面（候選片段瀏覽）
3. 即時預覽播放器
4. 字幕文字編輯
5. 配樂選擇器

**對應流程**：
- 流程二：影片生成流程（階段 4）

**技術需求**：
- 複雜的 UI 互動（時間軌拖拉、播放同步）
- 影片預覽播放（可能需要動態組合片段）
- 即時同步更新

**對外介面**：
- API：查詢候選片段、更新時間軌草稿、觸發影片合成
- 與「智能選片引擎」、「影片合成引擎」互動

---

#### 模組 4：用戶介面核心模組

**職責**：
- 整體 UI 框架
- 導航與路由
- 狀態管理
- 共用元件（按鈕、卡片、對話框等）
- 通知與錯誤提示

**核心功能**：
1. 應用路由（素材頁、錄音頁、編輯頁）
2. 全局狀態管理（用戶登入、當前專案等）
3. 共用 UI 元件庫
4. Toast 通知
5. Loading 狀態

**技術需求**：
- 前端框架（React/Vue/Svelte）
- 狀態管理（Redux/Vuex/Zustand）
- UI 元件庫

**對外介面**：
- 提供基礎框架給其他前端模組使用

---

#### 模組 5：用戶認證模組（前端部分）

**職責**：
- 登入/註冊介面
- 用戶資料顯示
- Token 管理
- 登出

**核心功能**：
1. 登入表單
2. 註冊表單
3. Token 儲存（localStorage）
4. 自動登入（Token 驗證）
5. 登出功能

**技術需求**：
- JWT Token 管理
- 安全性處理（HTTPS、XSS 防護）

**對外介面**：
- API：登入、註冊、驗證 Token
- 與後端「API 服務層」互動

---

### 後端層 (Backend)

---

#### 模組 6：素材處理引擎

**職責**：
- 接收上傳的影片檔案
- 呼叫外部 AI 服務分析影片
- 自動切分片段
- 自動打標籤
- 生成縮圖

**核心功能**：
1. 影片上傳接收（presigned URL）
2. 呼叫 Google Video AI / AWS Rekognition
3. 分析結果轉換為內部 tag 格式
4. 片段切分邏輯
5. 縮圖生成（FFmpeg）
6. 寫入資料庫

**對應流程**：
- 流程一：素材管理流程（階段 2、階段 3）

**技術需求**：
- 影片處理（FFmpeg）
- AI API 整合
- 背景任務處理（Queue）

**對外介面**：
- API：觸發素材分析
- 資料庫：寫入 segments、segment_tags
- 外部服務：Google Video AI / AWS Rekognition

**輸入/輸出**：
- 輸入：影片檔案 URL
- 輸出：segments 資料、tags 資料、縮圖 URL

---

#### 模組 7：配音處理引擎

**職責**：
- 接收配音檔案
- 語音轉文字（STT）
- 語意分析
- 配音切分
- 關鍵字提取

**核心功能**：
1. 接收音檔
2. 呼叫 STT 服務（OpenAI Whisper / AssemblyAI）
3. 文字信心分數檢查
4. 語意分析（使用 LLM）
5. 配音切分（根據語意）
6. 關鍵字提取

**對應流程**：
- 流程二：影片生成流程（階段 2）

**技術需求**：
- STT API 整合
- LLM API 整合（語意分析）
- Prompt 設計

**對外介面**：
- API：處理配音
- 外部服務：OpenAI Whisper、GPT-4 / Claude
- 資料庫：寫入配音文字、時間軸

**輸入/輸出**：
- 輸入：音檔
- 輸出：文字腳本、時間軸標記、語意分析結果

---

#### 模組 8：智能選片引擎（核心競爭力！）

**職責**：
- 根據配音內容選擇素材
- 組合素材成時間軸
- 像導演一樣做決策
- 確保影片流暢、有節奏

**核心功能**：
1. 配音切分決策（片段長度分配）
2. 為每個片段搜尋候選素材（資料庫查詢）
3. AI 選片決策（使用 LLM）
4. 素材組合檢查（避免重複、確保流暢）
5. 生成影片時間軸 JSON
6. 候選片段推薦（供用戶替換）

**對應流程**：
- 流程二：影片生成流程（階段 3）

**技術需求**：
- 複雜的 AI Prompt 設計（導演決策）
- 資料庫查詢優化（tag 搜尋）
- LLM API 整合

**對外介面**：
- API：生成時間軌、推薦候選片段
- 資料庫：查詢 segments、segment_tags
- 外部服務：OpenAI GPT-4 / Claude

**輸入/輸出**：
- 輸入：配音切分結果、素材庫資料
- 輸出：時間軸 JSON（每個時間段對應的 segment_id + 裁切資訊）

**關鍵設計點**：
- 這是產品的核心價值！
- Prompt 設計決定影片品質
- 需要大量測試與迭代

---

#### 模組 9：影片合成引擎

**職責**：
- 根據時間軸 JSON 合成影片
- 加上配音、字幕、配樂
- 加上轉場特效
- 輸出最終影片

**核心功能**：
1. 解析時間軸 JSON
2. 從儲存空間下載素材片段
3. 呼叫影片渲染服務（FFmpeg 或雲端 API）
4. 字幕樣式套用
5. 配樂混音
6. 轉場特效
7. 上傳最終影片到儲存空間

**對應流程**：
- 流程二：影片生成流程（階段 5）

**技術需求**：
- FFmpeg 指令設計（如果自建）
- 或雲端 API 整合（Mux / AWS MediaConvert）
- 背景任務處理（Queue）

**對外介面**：
- API：觸發影片合成
- 外部服務：FFmpeg / Mux / Cloudflare Stream
- 資料庫：寫入成品影片記錄

**輸入/輸出**：
- 輸入：時間軸 JSON、配音檔、素材片段 URL
- 輸出：完成的影片檔案 URL

---

#### 模組 10：API 服務層

**職責**：
- 提供 RESTful API 給前端
- 請求驗證
- 用戶認證與授權
- 路由分發
- 錯誤處理

**核心功能**：
1. API 路由定義
2. JWT Token 驗證（Middleware）
3. 請求參數驗證
4. 錯誤回應格式化
5. API 文件（Swagger）

**技術需求**：
- 後端框架（Node.js + Express / FastAPI / Go）
- JWT 驗證
- API 文件生成

**對外介面**：
- 提供 API 給前端
- 呼叫各個後端引擎

**API 設計範例**：
```
POST   /api/materials/upload          # 上傳素材
GET    /api/materials                 # 查詢素材列表
POST   /api/voiceover/upload          # 上傳配音
POST   /api/video/generate            # 生成影片時間軌
GET    /api/video/candidates/:id      # 查詢候選片段
POST   /api/video/render              # 觸發影片合成
GET    /api/video/:id                 # 查詢影片狀態
POST   /api/auth/login                # 登入
POST   /api/auth/register             # 註冊
```

---

#### 模組 11：資料管理模組

**職責**：
- 資料庫操作封裝
- 資料模型定義
- 查詢優化
- 資料遷移

**核心功能**：
1. ORM 封裝（Prisma / SQLAlchemy / GORM）
2. 資料模型定義
3. 資料庫遷移腳本
4. 查詢效能優化
5. 索引管理

**技術需求**：
- ORM 框架
- 資料庫遷移工具
- 查詢優化

**對外介面**：
- 提供資料存取介面給其他後端模組

**關鍵資料表**：
- users（用戶）
- videos（原始影片）
- segments（片段）
- segment_tags（片段標籤）
- voiceovers（配音）
- generated_videos（生成的影片）
- timelines（時間軸草稿）

---

### 資料與儲存層 (Data & Storage)

---

#### 模組 12：資料庫 (PostgreSQL)

**職責**：
- 儲存結構化資料
- 提供 ACID 交易
- 支援複雜查詢

**儲存內容**：
- 用戶資料
- 素材 metadata
- 片段與標籤資料
- 配音資料
- 時間軸資料
- 生成影片記錄

**技術選擇**：
- PostgreSQL（推薦）
- 雲端託管：Supabase / Railway / Neon

**關鍵設計**：
- 索引優化（tag 搜尋需要高效能）
- 外鍵關聯（segments → videos → users）

---

#### 模組 13：檔案儲存 (S3 / Cloudflare R2)

**職責**：
- 儲存影片檔案
- 儲存音檔
- 儲存縮圖
- 提供檔案下載

**儲存內容**：
- 原始影片檔案
- 配音音檔
- 縮圖圖片
- 生成的影片檔案

**技術選擇**：
- AWS S3 + CloudFront（傳統選擇）
- Cloudflare R2（更便宜）

**關鍵設計**：
- Presigned URL（安全上傳與下載）
- CDN 加速
- 檔案命名規則（避免衝突）

---

#### 模組 14：快取層 (Redis)

**職責**：
- 快取熱門查詢結果
- 快取候選片段推薦（關鍵！）
- 快取素材列表
- Session 管理
- 背景任務佇列

**核心使用場景**：

**1. 候選片段快取（用戶體驗關鍵！）**
```typescript
// 智能選片時同時快取所有候選片段
for (let segment of timeline.segments) {
  await redis.set(
    `candidates:timeline_${timelineId}:segment_${segment.index}`,
    JSON.stringify(segment.candidates),
    'EX', 3600  // 1 小時
  )
}

// 用戶在時間軌編輯時點擊替換 → 立即顯示候選片段（< 500ms）
const candidates = await redis.get(`candidates:timeline_${timelineId}:segment_${index}`)
```

**2. 素材列表快取**
```typescript
// 素材分析完成後快取
await redis.set(
  `materials:user_${userId}`,
  JSON.stringify(materialsWithTags),
  'EX', 7200  // 2 小時
)
```

**3. 配樂庫快取**
```typescript
// 配樂庫很少變動，可長時間快取
await redis.set(
  'music:library',
  JSON.stringify(musicList),
  'EX', 86400  // 24 小時
)
```

**4. 背景任務佇列**
- 素材分析任務
- 影片合成任務
- 使用 Bull (Node.js) 或 Celery (Python)

**技術選擇**：
- Redis
- 雲端託管：Upstash / Redis Cloud

**優先級**：
- 🟢 **高（MVP 建議實作）**
- 理由：候選片段快取直接影響用戶體驗，時間軌編輯流暢度是核心體驗

---

### 外部服務層 (External Services)

---

#### 模組 15：影片分析服務整合

**職責**：
- 整合外部影片分析 API
- 處理 API 回應
- 轉換為內部格式

**外部服務選擇**：
- Google Cloud Video Intelligence API
- AWS Rekognition Video

**封裝設計**：
- 抽象層設計（方便未來切換服務）
- 錯誤處理與重試

---

#### 模組 16：語音處理服務整合

**職責**：
- 整合 STT API
- 處理語音辨識結果

**外部服務選擇**：
- OpenAI Whisper API（推薦）
- AssemblyAI
- Google Cloud Speech-to-Text

**封裝設計**：
- 抽象層設計
- 信心分數檢查

---

#### 模組 17：AI 服務整合

**職責**：
- 整合 LLM API
- Prompt 管理
- 語意分析
- 智能決策

**外部服務選擇**：
- OpenAI GPT-4（推薦）
- Claude API
- 開源 LLM（Llama、Mistral）

**封裝設計**：
- Prompt 版本管理
- 抽象層設計（可切換 LLM）
- Token 成本追蹤

**關鍵 Prompt**：
- 配音切分 Prompt
- 語意分析 Prompt
- 導演選片 Prompt（核心競爭力！）

---

#### 模組 18：配樂服務整合

**職責**：
- 整合配樂庫 API
- 配樂搜尋與推薦
- 配樂下載

**外部服務選擇**：
- MVP：Pixabay Music API（免費）
- 未來：Artlist / Epidemic Sound（付費高品質）

**封裝設計**：
- 配樂 metadata 管理
- 情緒分類標籤

---

#### 模組 19：影片渲染服務整合

**職責**：
- 呼叫影片合成 API（或執行 FFmpeg）
- 處理渲染結果

**外部服務選擇**：
- MVP：Cloudflare Stream / Mux API（雲端）
- 未來：FFmpeg + Lambda（自建）

**封裝設計**：
- 抽象層設計（方便未來從雲端切換到自建）
- 渲染進度追蹤

---

## 模組依賴關係

### 依賴圖

```
前端模組依賴：
┌──────────────┐
│ 4. UI 核心   │ ← 所有前端模組的基礎
└──────┬───────┘
       ↓
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│ 1. 素材管理  │  │ 2. 錄音/配音 │  │ 3. 時間軌編輯│
└──────────────┘  └──────────────┘  └──────────────┘
       ↓                  ↓                  ↓
       └──────────────────┴──────────────────┘
                          ↓
                 ┌──────────────┐
                 │ 5. 用戶認證  │
                 └──────────────┘

後端模組依賴：
┌──────────────┐
│ 10. API 服務 │ ← 前端的唯一入口
└──────┬───────┘
       ↓
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│ 6. 素材處理  │  │ 7. 配音處理  │  │ 8. 智能選片  │
└──────┬───────┘  └──────┬───────┘  └──────┬───────┘
       │                  │                  │
       │                  └────────┬─────────┘
       ↓                           ↓
┌──────────────┐         ┌──────────────┐
│ 9. 影片合成  │ ←───────│ 11. 資料管理 │
└──────────────┘         └──────┬───────┘
                                 ↓
                        ┌──────────────┐
                        │ 12. 資料庫   │
                        └──────────────┘

外部服務依賴：
6. 素材處理 → 15. 影片分析服務
7. 配音處理 → 16. 語音處理服務、17. AI 服務
8. 智能選片 → 17. AI 服務
9. 影片合成 → 18. 配樂服務、19. 影片渲染服務
```

---

## 模組實作優先級

### MVP 階段必須實作（P0 - 最高優先級）

| 模組編號 | 模組名稱 | 理由 |
|---------|---------|------|
| 4 | 用戶介面核心模組 | 前端基礎框架 |
| 5 | 用戶認證模組 | 用戶隔離必須 |
| 10 | API 服務層 | 前後端通訊 |
| 11 | 資料管理模組 | 資料存取基礎 |
| 12 | 資料庫 | 資料儲存 |
| 13 | 檔案儲存 | 檔案儲存 |
| 14 | 快取層 | 候選片段快取，用戶體驗關鍵 |

### MVP 核心功能（P1 - 高優先級）

| 模組編號 | 模組名稱 | 理由 |
|---------|---------|------|
| 1 | 素材管理模組 | 流程一核心 |
| 2 | 錄音/配音模組 | 流程二起點 |
| 3 | 時間軌編輯模組 | 流程二核心 |
| 6 | 素材處理引擎 | 流程一核心 |
| 7 | 配音處理引擎 | 流程二核心 |
| 8 | 智能選片引擎 | 核心競爭力！ |
| 9 | 影片合成引擎 | 流程二核心 |
| 15-19 | 所有外部服務整合 | 支援核心功能 |

### 未來優化（P2 - 中優先級）

目前所有核心模組都已納入 MVP。

---

## 模組規模估算

### 開發工作量估算（人天）

| 模組編號 | 模組名稱 | 估算工作量 | 備註 |
|---------|---------|-----------|------|
| 1 | 素材管理模組 | 5-7 天 | UI 較複雜 |
| 2 | 錄音/配音模組 | 3-5 天 | Web Audio API 需測試 |
| 3 | 時間軌編輯模組 | 8-12 天 | 最複雜的 UI 模組 |
| 4 | 用戶介面核心模組 | 3-5 天 | 框架搭建 |
| 5 | 用戶認證模組 | 2-3 天 | 使用 Supabase 快速 |
| 6 | 素材處理引擎 | 5-8 天 | AI API 整合較複雜 |
| 7 | 配音處理引擎 | 4-6 天 | STT + LLM 整合 |
| 8 | 智能選片引擎 | 10-15 天 | 核心邏輯，需大量測試 |
| 9 | 影片合成引擎 | 5-8 天 | 雲端 API 較簡單；自建需更久 |
| 10 | API 服務層 | 3-5 天 | 基礎架構 |
| 11 | 資料管理模組 | 4-6 天 | Schema 設計 + ORM |
| 12-13 | 資料庫 + 儲存 | 2-3 天 | 雲端服務設定 |
| 14 | 快取層 | 2-3 天 | Redis 設定 + 快取策略 |
| 15-19 | 外部服務整合 | 已分散在各引擎中 | - |
| **總計（MVP）** | - | **56-86 天** | **約 2-3 個月（單人）** |

**團隊配置建議**：
- 前端工程師 1 人：負責模組 1-5（約 21-32 天）
- 後端工程師 1 人：負責模組 6-14（約 35-54 天）
- **並行開發可在 1.5-2 個月內完成 MVP**

---

## 模組間通訊協議

### API 通訊格式

**請求格式**：
```json
{
  "action": "upload_material",
  "data": { ... },
  "user_id": "uuid"
}
```

**回應格式**：
```json
{
  "success": true,
  "data": { ... },
  "error": null,
  "timestamp": "2025-10-06T10:00:00Z"
}
```

### 關鍵資料結構

**時間軌 JSON 格式**：
```json
{
  "timeline_id": "uuid",
  "voiceover_url": "https://...",
  "total_duration": 45,
  "segments": [
    {
      "index": 0,
      "start_time": 0,
      "end_time": 5,
      "video_segment_id": "seg_001",
      "video_trim_start": 2,
      "video_trim_end": 7,
      "subtitle_text": "大家好，今天要介紹...",
      "subtitle_style": "default"
    },
    {
      "index": 1,
      "start_time": 5,
      "end_time": 13,
      "video_segment_id": "seg_015",
      "video_trim_start": 0,
      "video_trim_end": 8,
      "subtitle_text": "這個產品有三大特色...",
      "subtitle_style": "default"
    }
  ],
  "music": {
    "music_id": "bgm_001",
    "volume": 0.3,
    "fade_in": 1,
    "fade_out": 2
  }
}
```

---

## 模組測試策略

### 單元測試

| 模組 | 測試重點 |
|------|---------|
| 6. 素材處理引擎 | AI API 回應解析、tag 轉換邏輯 |
| 7. 配音處理引擎 | STT 結果處理、語意分析 Prompt |
| 8. 智能選片引擎 | 選片邏輯、候選查詢、重複檢查 |
| 11. 資料管理模組 | 資料庫查詢邏輯 |

### 整合測試

| 整合點 | 測試重點 |
|--------|---------|
| 流程一完整測試 | 上傳 → 分析 → 標記 → 查詢 |
| 流程二完整測試 | 錄音 → STT → 選片 → 合成 |
| 外部服務整合 | API 錯誤處理、重試機制 |

### E2E 測試

- 完整用戶流程：註冊 → 上傳素材 → 錄音 → 生成影片 → 下載

---

## 完成檢查

- [x] 清楚定義了所有核心模組（19 個模組）
- [x] 明確各模組的職責與邊界
- [x] 繪製了模組依賴關係圖
- [x] 定義了模組實作優先級
- [x] 估算了開發工作量
- [x] 設計了模組間通訊協議
- [x] 規劃了測試策略

**完成後**：更新 `00-INDEX.md` 狀態，繼續步驟 5
